# network interface settings; autogenerated
# Please do NOT modify this file directly, unless you know what
# you're doing.
#
# If you want to manage parts of the network configuration manually,
# please utilize the 'source' or 'source-directory' directives to do
# so.
# PVE will preserve these directives, but will NOT read its network
# configuration from sourced files, so do not attempt to move any of
# the PVE managed interfaces into external files!

source /etc/network/interfaces.d/*

auto lo
iface lo inet loopback

iface eno2 inet manual
iface eno2 inet6 manual


auto vmbr0
iface vmbr0 inet static
	address 192.168.69.218/16
	gateway 192.168.69.1
	netmask 255.255.0.0
	bridge-ports eno2
	bridge-stp off
	bridge-fd 0

#bkk40
#flapping
iface enp193s0f0np0 inet manual
    	ovs_type OVSPort
    	ovs_bridge cephbr0
    	ovs_mtu 9000
    	ovs_options vlan_mode=trunk trunks=100,200 other_config:rstp-enable=true other_config:rstp-path-cost=128 other_config:rstp-port-admin-edge=false other_config:rstp-port-auto-edge=false other_config:rstp-port-mcheck=true

#bkk30
auto enp193s0f1np1
iface enp193s0f1np1 inet manual
    	ovs_type OVSPort
    	ovs_bridge cephbr0
    	ovs_mtu 9000
    	ovs_options vlan_mode=trunk trunks=100,200 other_config:rstp-enable=true other_config:rstp-path-cost=128 other_config:rstp-port-admin-edge=false other_config:rstp-port-auto-edge=false other_config:rstp-port-mcheck=true

auto cephbr0
iface cephbr0 inet static
    address 10.255.255.8/24
    ovs_type OVSBridge
    ovs_ports enp193s0f1np1 enp193s0f0np0 vpublic vprivate
    ovs_mtu 9000
    pre-up ip link set dev enp193s0f0np0 mtu 9000
    pre-up ip link set dev enp193s0f1np1 mtu 9000
    up ovs-vsctl set Bridge ${IFACE} rstp_enable=true other_config:rstp-priority=32768 other_config:rstp-forward-delay=4 other_config:rstp-max-age=6
    post-up ovs-vsctl set Port enp193s0f0np0 vlan_mode=trunk trunks=100,200
    post-up ovs-vsctl set Port enp193s0f1np1 vlan_mode=trunk trunks=100,200
    # VLAN 200 flows
    post-up ovs-ofctl add-flow ${IFACE} "priority=250,in_port=enp193s0f0np0,dl_vlan=200,actions=strip_vlan,output:vprivate"
    post-up ovs-ofctl add-flow ${IFACE} "priority=250,in_port=enp193s0f1np1,dl_vlan=200,actions=strip_vlan,output:vprivate"
    post-up ovs-ofctl add-flow ${IFACE} "priority=250,in_port=vprivate,actions=push_vlan:0x8100,mod_vlan_vid:200,output:enp193s0f0np0,output:enp193s0f1np1"
    # VLAN 100 flows
    post-up ovs-ofctl add-flow ${IFACE} "priority=250,in_port=enp193s0f0np0,dl_vlan=100,actions=strip_vlan,output:vpublic"
    post-up ovs-ofctl add-flow ${IFACE} "priority=250,in_port=enp193s0f1np1,dl_vlan=100,actions=strip_vlan,output:vpublic"
    post-up ovs-ofctl add-flow ${IFACE} "priority=250,in_port=vpublic,actions=push_vlan:0x8100,mod_vlan_vid:100,output:enp193s0f0np0,output:enp193s0f1np1"
    post-up sleep 10
    post-up ip link set dev ${IFACE} mtu 9000

iface cephbr0 inet6 static
    address fd00:255:255::8/64

auto vpublic
iface vpublic inet static
  ovs_type OVSIntPort
  ovs_bridge cephbr0
  ovs_options tag=100
  address 10.255.100.8/24
  ovs_mtu 9000

iface vpublic inet6 static
  address fd00:255:100::8/64

auto vprivate
iface vprivate inet static
  ovs_type OVSIntPort
  ovs_bridge cephbr0
  ovs_options tag=200
  address 10.255.200.8/24
  ovs_mtu 9000

iface vprivate inet6 static
  address fd00:255:200::8/64

#iface enp193s0f0np0 inet manual

#iface enp193s0f1np1 inet manual

iface enxb03af2b6059f inet manual

auto eno1
iface eno1 inet manual
    	ovs_type OVSPort
    	ovs_bridge eno1br0
    	ovs_mtu 9000
    	ovs_options vlan_mode=trunk trunks=400 other_config:rstp-enable=true other_config:rstp-path-cost=128 other_config:rstp-port-admin-edge=false other_config:rstp-port-auto-edge=false other_config:rstp-port-mcheck=true

auto eno1br0
iface eno1br0 inet manual
	ovs_type OVSBridge
	ovs_ports eno1 vlan400
	ovs_mtu 9000
	up ovs-vsctl set Bridge ${IFACE} rstp_enable=true
	pre-up ip link set dev eno1 mtu 9000
	up ovs-vsctl set Bridge ${IFACE} rstp_enable=true other_config:rstp-priority=32768 other_config:rstp-forward-delay=4 other_config:rstp-max-age=6
	# VLAN 400 flows
	post-up ovs-ofctl add-flow ${IFACE} "priority=250,in_port=eno1,dl_vlan=400,actions=strip_vlan,output:vlan400"
	post-up ovs-ofctl add-flow ${IFACE} "priority=250,in_port=vlan400,actions=push_vlan:0x8100,mod_vlan_vid:400,output:eno1"
	post-up sleep 10
	post-up ip link set dev ${IFACE} mtu 9000
	post-up ovs-vsctl set Port eno1 vlan_mode=trunk trunks=400

auto vlan400
iface vlan400 inet static
    ovs_type OVSIntPort
    ovs_bridge eno1br0
    ovs_options tag=400
    address 10.155.254.8/24
    ovs_mtu 9000

iface vlan400 inet6 static
    address fd00:155:254::8/64
