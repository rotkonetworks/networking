# /etc/network/interfaces for bkk06
# this file describes the network interfaces available on your system
# and how to activate them. for more information, see interfaces(5).

source /etc/network/interfaces.d/*

# the loopback network interface
auto lo
iface lo inet loopback
    # router ID
    up ip addr add 10.155.255.6/32 dev lo
    # public IPv4
    up ip addr add 160.22.181.6/32 dev lo
    # anycast local IPs
    up ip addr add 160.22.181.81/32 dev lo
    # anycast global IPs
    up ip addr add 160.22.180.180/32 dev lo

iface lo inet6 loopback
    # router ID
    up ip -6 addr add fd00:155:255::6/128 dev lo
    # public IPv6
    up ip -6 addr add 2401:a860:1006::/128 dev lo
    # anycast local IPv6
    up ip -6 addr add 2401:a860:1081::/128 dev lo
    # anycast global IPv6
    up ip -6 addr add 2401:a860::/128 dev lo

# physical interfaces
iface eno2 inet manual
iface eno2 inet6 manual

# management bridge
auto vmbr0
iface vmbr0 inet static
    address 192.168.76.1
    netmask 255.255.0.0
    gateway 192.168.69.1
    bridge-ports eno2
    bridge-stp off
    bridge-fd 0
iface vmbr0 inet6 static
    address 2401:a860:1181::76/64
    gateway 2401:a860:1181::1
    pre-up echo 0 > /proc/sys/net/ipv6/conf/vmbr0/accept_ra
    pre-up echo 0 > /proc/sys/net/ipv6/conf/vmbr0/autoconf
    accept_ra 0
    autoconf 0

# physical interfaces for bonding
iface enp193s0f1np1 inet manual
iface eno1 inet manual

# unused interfaces
iface enp193s0f0np0 inet manual
iface enxbe3af2b6059f inet manual

# LACP bond of both trunks
auto bond0
iface bond0 inet manual
    bond-slaves enp193s0f1np1 eno1 
    bond-mode 802.3ad
    bond-miimon 100
    bond-lacp-rate fast
    mtu 9000

# Q-in-Q outer VLAN 400 on the bond
auto bond0.400
iface bond0.400 inet manual
    vlan-raw-device bond0
    vlan-id 400
    mtu 9000

# Q-in-Q inner VLAN 106 (to bkk00/rr1)
auto vlan106
iface vlan106 inet manual
    vlan-raw-device bond0.400
    vlan-id 106
    mtu 9000

# Q-in-Q inner VLAN 206 (to bkk20/rr2)
auto vlan206
iface vlan206 inet manual
    vlan-raw-device bond0.400
    vlan-id 206
    mtu 9000

# Q-in-Q inner VLAN 306 (via bkk10 to bkk00/rr2)
auto vlan306
iface vlan306 inet manual
    vlan-raw-device bond0.400
    vlan-id 306
    mtu 1500
    
# Q-in-Q inner VLAN 406 (via bkk10 to bkk20/rr2)
auto vlan406
iface vlan406 inet manual
    vlan-raw-device bond0.400
    vlan-id 406
    mtu 1500

# internal services bridge
auto vmbr1
iface vmbr1 inet static
    address 10.6.0.1
    netmask 255.255.0.0
    bridge-ports none
    bridge-stp off
    bridge-fd 0

iface vmbr1 inet6 static
    address 2401:a860:1006::1/48
    accept_ra 0
    autoconf 0

# public services bridge (Q-in-Q terminated)
auto vmbr2
iface vmbr2 inet static
    bridge-ports vlan206 vlan106
    bridge-stp off
    bridge-fd 0
    address 10.155.106.1/31
    address 10.155.206.1/31
    mtu 1500
    # anycast source routing for IPv4
    post-up echo "100 anycast" >> /etc/iproute2/rt_tables 2>/dev/null || true
    post-up ip rule add from 160.22.181.81 table anycast priority 100 2>/dev/null || true
    post-up ip rule add from 160.22.180.180 table anycast priority 100 2>/dev/null || true
    post-up ip route add default table anycast nexthop via 10.155.106.0 dev vmbr2 weight 1 nexthop via 10.155.206.0 dev vmbr2 weight 1 2>/dev/null || true
    # cleanup on interface down
    pre-down ip rule del from 160.22.181.81 table anycast 2>/dev/null || true
    pre-down ip rule del from 160.22.180.180 table anycast 2>/dev/null || true
    pre-down ip route flush table anycast 2>/dev/null || true

iface vmbr2 inet6 static
    address fd00:155:106::1/127
    address fd00:155:206::1/127
    accept_ra 0
    autoconf 0
    # anycast source routing for IPv6
    post-up echo "100 anycast" >> /etc/iproute2/rt_tables 2>/dev/null || true
    post-up ip -6 rule add from 2401:a860:1081:: table anycast priority 100 2>/dev/null || true
    post-up ip -6 rule add from 2401:a860:: table anycast priority 100 2>/dev/null || true
    post-up ip -6 route add default table anycast nexthop via fd00:155:106:: dev vmbr2 weight 1 nexthop via fd00:155:206:: dev vmbr2 weight 1 2>/dev/null || true
    # cleanup on interface down
    pre-down ip -6 rule del from 2401:a860:1081:: table anycast 2>/dev/null || true
    pre-down ip -6 rule del from 2401:a860:: table anycast 2>/dev/null || true
    pre-down ip -6 route flush table anycast 2>/dev/null || true
