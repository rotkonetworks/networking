# This file describes the network interfaces available on your system
# and how to activate them. For more information, see interfaces(5).

source /etc/network/interfaces.d/*

# The loopback network interface
auto lo
iface lo inet loopback
iface lo inet6 loopback
    # IPv6 primary loopback
    #up ip -6 addr add 2401:a860:181::6/128 dev lo
    #RouterId
    up ip -6 addr add fd00:155:255::6/128 dev lo
    # IPv4 legacy loopback
    #up ip addr add 160.22.181.6/32 dev lo
    #RouterId
    up ip addr add 10.155.255.6/32 dev lo

# Physical interface connections:
# eno1 → bkk10 (redundant path for public traffic)
iface eno1 inet manual
iface eno1 inet6 manual

# eno2 → bkk50 (primary path for public traffic)
iface eno2 inet manual
iface eno2 inet6 manual

# EXISTING: Management bridge via bkk50 (keep for existing containers)
auto vmbr0
iface vmbr0 inet static
	address 192.168.76.1/16
	gateway 192.168.69.1
	netmask 255.255.0.0
	bridge-ports eno2
	bridge-stp off
	bridge-fd 0
iface vmbr0 inet6 static
	address 2401:a860:1181::76/64
	gateway 2401:a860:1181::1
	pre-up echo 0 > /proc/sys/net/ipv6/conf/vmbr0/accept_ra
	pre-up echo 0 > /proc/sys/net/ipv6/conf/vmbr0/autoconf
	accept_ra 0
	autoconf 0

# NEW: Redundant public bridge using both paths (eno1→bkk10, eno2→bkk50)
#auto bond0
#iface bond0 inet manual
	#bond-slaves eno1 eno2
	#bond-mode active-backup
	#bond-miimon 100
	#bond-primary eno2
	#bond-downdelay 200
	#bond-updelay 200

#auto vmbr1
#iface vmbr1 inet static
	#address 160.22.181.6/24
	#bridge-ports bond0
	#bridge-stp off
	#bridge-fd 0
	## Dual gateway setup for redundancy
	#post-up ip route add default via 160.22.181.10 dev vmbr1 metric 1 table 100  # bkk10
	#post-up ip route add default via 160.22.181.50 dev vmbr1 metric 1 table 101  # bkk50
	#post-up ip rule add from 160.22.181.0/24 table 100
	#post-up ip rule add from 160.22.181.0/24 table 101
#iface vmbr1 inet6 static
	#address 2401:a860:1181::6/64
	#gateway 2401:a860:1181::1
	#accept_ra 0
	#autoconf 0

# use to be enp193s0f0np0 → bkk40 (100G port 0 - not used yet)
# now not in designed use
# auto enp193s0f0np0
# iface enp193s0f0np0 inet manual
#	ovs_type OVSPort
#	ovs_bridge cephbr0
#	ovs_mtu 9000

# enp193s0f1np1 → bkk30 (100G port 1 - Ceph storage network)
# whole networking going to be routed via here as prio
auto enp193s0f1np1
iface enp193s0f1np1 inet manual
    	ovs_type OVSPort
    	ovs_bridge vlanbr0
    	ovs_mtu 9000
    	ovs_options vlan_mode=trunk trunks=100,200

#QinQ section
auto vlanraw400
iface vlanraw400 inet manual
    vlan-raw-device enp193s0f1np1
    vlan-id 400
    mtu 9000

auto vlan106
iface vlan106 inet manual
    vlan-raw-device vlanraw400
    vlan-id 106
    mtu 1500

auto vlan206
iface vlan206 inet manual
    vlan-raw-device vlanraw400
    vlan-id 206
    mtu 1500

# Internal services bridge (IPv6 primary)
auto vmbr1
iface vmbr1 inet6 static
    #address 2401:a860:6::1/64
    bridge-ports none
    bridge-stp off
    bridge-fd 0
    # Enable RA only on this interface if needed
    post-up echo 1 > /proc/sys/net/ipv6/conf/vmbr1/accept_ra
    post-up echo 1 > /proc/sys/net/ipv6/conf/vmbr1/autoconf
    accept_ra 1
    autoconf 1
    # IPv6 routing for internal subnets
    #post-up ip -6 route add 2401:a860:6::/48 dev vmbr1

iface vmbr1 inet static
    address 10.6.0.1/24

# Public services bridge (Q-in-Q terminated)
auto vmbr2
iface vmbr2 inet static
    bridge-ports vlan206 vlan106
    bridge-stp off
    bridge-fd 0
    address 10.155.106.1/31
    address 10.155.206.1/31
    mtu 1500

iface vmbr2 inet6 static
    address fd00:155:106::1/127
    address fd00:155:206::1/127
    # Public IPs assigned to lo, not bridge
    # BGP will handle routing

# Ceph storage bridge (connects to bkk30 via enp193s0f1np1)
# needs rework for bgp:s(more vlans)
auto vlanbr0
iface vlanbr0 inet static
    address 10.255.255.6/24
    ovs_type OVSBridge
    ovs_ports enp193s0f1np1 vpublic vprivate
    ovs_mtu 9000
    pre-up ip link set dev enp193s0f1np1 mtu 9000
    up ovs-vsctl set Bridge ${IFACE} rstp_enable=true
    post-up ovs-vsctl set Port enp193s0f1np1 vlan_mode=trunk trunks=100,200
    # VLAN 200 flows (private/storage)
    post-up ovs-ofctl add-flow ${IFACE} "priority=250,in_port=enp193s0f1np1,dl_vlan=200,actions=strip_vlan,output:vprivate"
    post-up ovs-ofctl add-flow ${IFACE} "priority=250,in_port=vprivate,actions=push_vlan:0x8100,mod_vlan_vid:200,output:enp193s0f1np1"
    # VLAN 100 flows (public/application)
    post-up ovs-ofctl add-flow ${IFACE} "priority=250,in_port=enp193s0f1np1,dl_vlan=100,actions=strip_vlan,output:vpublic"
    post-up ovs-ofctl add-flow ${IFACE} "priority=250,in_port=vpublic,actions=push_vlan:0x8100,mod_vlan_vid:100,output:enp193s0f1np1"
    post-up sleep 10
    post-up ip link set dev ${IFACE} mtu 9000
iface vlanbr0 inet6 static
    address fd00:255:255::6/64

# VLAN 100 - Public/application traffic
auto vpublic
iface vpublic inet static
  ovs_type OVSIntPort
  ovs_bridge vlanbr0
  ovs_options tag=100
  address 10.255.100.6/24
  ovs_mtu 9000
iface vpublic inet6 static
  address fd00:255:100::6/64

# VLAN 200 - Private/storage traffic (Ceph)
auto vprivate
iface vprivate inet static
  ovs_type OVSIntPort
  ovs_bridge vlanbr0
  ovs_options tag=200
  address 10.255.200.6/24
  ovs_mtu 9000
iface vprivate inet6 static
  address fd00:255:200::6/64
