# /etc/network/interfaces for bkk07
# Generated by ./deploy/network/gencfg.sh on 2025-07-25 10:15:54 UTC
#
# Routing table structure:
#   Table 100 (public)    - All public traffic (unicast + anycast)
#   Table 101 (internal)  - Internal services traffic
#   Table 102 (mgmt)      - Management traffic
#   Table 103 (anycast-local)  - Local anycast (optional, future use)
#   Table 104 (anycast-global) - Global anycast (optional, future use)
#
# This file describes the network interfaces available on your system
# and how to activate them. For more information, see interfaces(5).

source /etc/network/interfaces.d/*

# Create routing tables on boot
auto lo
iface lo inet loopback
    # Create all routing tables
    up echo "100 public" >> /etc/iproute2/rt_tables 2>/dev/null || true
    up echo "101 internal" >> /etc/iproute2/rt_tables 2>/dev/null || true
    up echo "102 mgmt" >> /etc/iproute2/rt_tables 2>/dev/null || true
    up echo "103 anycast-local" >> /etc/iproute2/rt_tables 2>/dev/null || true
    up echo "104 anycast-global" >> /etc/iproute2/rt_tables 2>/dev/null || true
    # router ID
    up ip addr add 10.155.255.7/32 dev lo
    # public IPv4
    up ip addr add 160.22.181.7/32 dev lo
    # anycast local IPs
    up ip addr add 160.22.181.81/32 dev lo
    # anycast global IPs
    up ip addr add 160.22.180.180/32 dev lo

iface lo inet6 loopback
    # router ID
    up ip -6 addr add fd00:155:255::7/128 dev lo
    # public IPv6
    up ip -6 addr add 2401:a860:1007::/128 dev lo
    # anycast local IPv6
    up ip -6 addr add 2401:a860:1081::/128 dev lo
    # anycast global IPv6
    up ip -6 addr add 2401:a860::/128 dev lo

# physical interfaces
iface eno2 inet manual
iface eno2 inet6 manual

# management bridge
auto vmbr0
iface vmbr0 inet static
    address 192.168.77.1
    netmask 255.255.0.0
    gateway 192.168.69.1
    bridge-ports eno2
    bridge-stp off
    bridge-fd 0
    # Management routing policy
    post-up ip route add default via 192.168.69.1 dev vmbr0 table mgmt
    post-up ip rule add from 192.168.77.1 table mgmt priority 300
    post-up ip rule add iif vmbr0 table mgmt priority 310
    pre-down ip rule del from 192.168.77.1 table mgmt 2>/dev/null || true
    pre-down ip rule del iif vmbr0 table mgmt 2>/dev/null || true
    pre-down ip route flush table mgmt 2>/dev/null || true

# physical interfaces for split uplinks
iface enp1s0f1np1 inet manual
    mtu 9000

iface eno1 inet manual
    mtu 9000

# unused interfaces
iface enp1s0f0np0 inet manual
iface enxbe3af2b6059f inet manual

# VLAN 400 on each physical interface
auto 100p1.400
iface 100p1.400 inet manual
    vlan-raw-device enp1s0f1np1
    vlan-id 400
    mtu 9000

auto eno1.400
iface eno1.400 inet manual
    vlan-raw-device eno1
    vlan-id 400
    mtu 9000

# Q-in-Q inner VLANs on first interface (via bkk30)
auto vlan107
iface vlan107 inet manual
    vlan-raw-device 100p1.400
    vlan-id 107
    mtu 1500

auto vlan207
iface vlan207 inet manual
    vlan-raw-device 100p1.400
    vlan-id 207
    mtu 1500

# Q-in-Q inner VLANs on second interface (via bkk10)
auto vlan117
iface vlan117 inet manual
    vlan-raw-device eno1.400
    vlan-id 117
    mtu 1500

auto vlan217
iface vlan217 inet manual
    vlan-raw-device eno1.400
    vlan-id 217
    mtu 1500

# Bond to bkk00 (direct + via bkk10)
auto bond-bkk00
iface bond-bkk00 inet manual
    bond-slaves vlan107 vlan117
    bond-mode active-backup
    bond-primary vlan107
    bond-miimon 100
    bond-lacp-rate fast
    bond-xmit-hash-policy layer3+4
    mtu 1500

# Bond to bkk20 (direct + via bkk10)
auto bond-bkk20
iface bond-bkk20 inet manual
    bond-slaves vlan207 vlan217
    bond-mode active-backup
    bond-primary vlan207
    bond-miimon 100
    bond-lacp-rate fast
    bond-xmit-hash-policy layer3+4
    mtu 1500

# internal services bridge
auto vmbr1
iface vmbr1 inet static
    address 10.7.0.1
    netmask 255.255.0.0
    bridge-ports none
    bridge-stp off
    bridge-fd 0
    # Internal services routing policy
    post-up ip route add 10.0.0.0/8 via 10.7.0.1 dev vmbr1 table internal
    post-up ip route add 172.16.0.0/12 via 10.7.0.1 dev vmbr1 table internal
    post-up ip route add 192.168.0.0/16 via 10.7.0.1 dev vmbr1 table internal
    post-up ip rule add from 10.7.0.0/16 table internal priority 200
    post-up ip rule add iif vmbr1 table internal priority 210
    pre-down ip rule del from 10.7.0.0/16 table internal 2>/dev/null || true
    pre-down ip rule del iif vmbr1 table internal 2>/dev/null || true
    pre-down ip route flush table internal 2>/dev/null || true

iface vmbr1 inet6 static
    address 2401:a860:1007::1/48
    accept_ra 0
    autoconf 0
    # Internal services routing policy for IPv6
    post-up ip -6 route add fd00::/8 via 2401:a860:1007::1 dev vmbr1 table internal
    post-up ip -6 route add fe80::/10 via 2401:a860:1007::1 dev vmbr1 table internal
    post-up ip -6 rule add from 2401:a860:1007::/48 table internal priority 200
    post-up ip -6 rule add iif vmbr1 table internal priority 210
    pre-down ip -6 rule del from 2401:a860:1007::/48 table internal 2>/dev/null || true
    pre-down ip -6 rule del iif vmbr1 table internal 2>/dev/null || true
    pre-down ip -6 route flush table internal 2>/dev/null || true

# public services bridge
auto vmbr2
iface vmbr2 inet static
    bridge-ports bond-bkk00 bond-bkk20
    bridge-stp off
    bridge-fd 0
    address 10.155.107.1/31
    address 10.155.207.1/31
    mtu 1500
    # Public services routing policy with ECMP
    # All public traffic uses table 100 (public)
    post-up ip route add default table public nexthop via 10.155.107.0 dev vmbr2 weight 1 nexthop via 10.155.207.0 dev vmbr2 weight 1
    # Source-based rules for public IPs (priority 100-109)
    post-up ip rule add from 160.22.181.7 table public priority 100
    post-up ip rule add from 160.22.181.81 table public priority 101
    post-up ip rule add from 160.22.180.180 table public priority 102
    # Critical: route return traffic via incoming interface
    post-up ip rule add iif vmbr2 table public priority 150
    # Cleanup rules on interface down
    pre-down ip rule del from 160.22.181.7 table public 2>/dev/null || true
    pre-down ip rule del from 160.22.181.81 table public 2>/dev/null || true
    pre-down ip rule del from 160.22.180.180 table public 2>/dev/null || true
    pre-down ip rule del iif vmbr2 table public 2>/dev/null || true
    pre-down ip route flush table public 2>/dev/null || true

iface vmbr2 inet6 static
    address fd00:155:107::1/127
    address fd00:155:207::1/127
    accept_ra 0
    autoconf 0
    # Public services routing policy for IPv6 with ECMP
    post-up ip -6 route add default table public nexthop via fd00:155:107:: dev vmbr2 weight 1 nexthop via fd00:155:207:: dev vmbr2 weight 1
    # Source-based rules for public IPv6 (priority 100-109)
    post-up ip -6 rule add from 2401:a860:1007:: table public priority 100
    post-up ip -6 rule add from 2401:a860:1081:: table public priority 101
    post-up ip -6 rule add from 2401:a860:: table public priority 102
    # Critical: route return traffic via incoming interface
    post-up ip -6 rule add iif vmbr2 table public priority 150
    # Cleanup rules on interface down
    pre-down ip -6 rule del from 2401:a860:1007:: table public 2>/dev/null || true
    pre-down ip -6 rule del from 2401:a860:1081:: table public 2>/dev/null || true
    pre-down ip -6 rule del from 2401:a860:: table public 2>/dev/null || true
    pre-down ip -6 rule del iif vmbr2 table public 2>/dev/null || true
    pre-down ip -6 route flush table public 2>/dev/null || true
