# /etc/network/interfaces for bkk07
# Generated by ./deploy/network/gencfg.sh on 2026-01-23 12:52:21 UTC
#
# Routing architecture:
#   Main table (254) - Managed by BIRD, contains full BGP routes
#   Table 102 (mgmt) - Management traffic isolation
#   Table 100 (anycast) - Anycast source routing
#
# Using unified BGP RR network on VLAN 400.100
#
# Three-tier anycast:
#   - Local (ULA): Internal services only
#   - Site (GUA): Bangkok-only public services
#   - Global (GUA): Worldwide public services

source /etc/network/interfaces.d/*

# the loopback network interface
auto lo
iface lo inet loopback
    up grep -q "^102[[:space:]]mgmt" /etc/iproute2/rt_tables || echo "102 mgmt" >> /etc/iproute2/rt_tables
    up grep -q "^100[[:space:]]anycast" /etc/iproute2/rt_tables || echo "100 anycast" >> /etc/iproute2/rt_tables
    # router ID
    up ip addr add 10.155.255.7/32 dev lo
    # public IPv4
    up ip addr add 160.22.181.7/32 dev lo
    # anycast local (ULA) - internal services
    up ip addr add 10.155.181.81/32 dev lo
    # anycast site (GUA) - Bangkok only
    up ip addr add 160.22.181.81/32 dev lo
    # anycast global (GUA) - worldwide
    up ip addr add 160.22.180.180/32 dev lo

iface lo inet6 loopback
    # router ID
    up ip -6 addr add fd00:155:255::7/128 dev lo
    # public IPv6
    up ip -6 addr add 2401:a860:1007::/128 dev lo
    # anycast local (ULA) - internal services
    up ip -6 addr add fd00:a860:1081::/128 dev lo
    # anycast site (GUA) - Bangkok only
    up ip -6 addr add 2401:a860:1081::/128 dev lo
    # anycast global (GUA) - worldwide
    up ip -6 addr add 2401:a860::/128 dev lo

# physical interfaces
iface eno2 inet manual
iface eno2 inet6 manual

# management bridge
auto vmbr0
iface vmbr0 inet static
    address 192.168.77.1
    netmask 255.255.0.0
    gateway 192.168.69.1
    bridge-ports eno2
    bridge-stp off
    bridge-fd 0
    # management routing isolation
    post-up ip route add default via 192.168.69.1 dev vmbr0 table mgmt
    post-up ip route add 192.168.0.0/16 dev vmbr0 table mgmt
    post-up ip rule add from 192.168.77.1 table mgmt priority 300
    post-up ip rule add to 192.168.77.1 table mgmt priority 301
    post-up ip rule add iif vmbr0 table mgmt priority 310
    pre-down ip rule del from 192.168.77.1 table mgmt 2>/dev/null || true
    pre-down ip rule del to 192.168.77.1 table mgmt 2>/dev/null || true
    pre-down ip rule del iif vmbr0 table mgmt 2>/dev/null || true
    pre-down ip route flush table mgmt 2>/dev/null || true

# physical interfaces for split uplinks
iface enp1s0f1np1 inet manual
    mtu 9000

iface eno1 inet manual
    mtu 9000

# unused interfaces
iface enp1s0f0np0 inet manual
iface enxbe3af2b6059f inet manual

# VLAN 400 on each physical interface
auto enp.400
iface enp.400 inet manual
    vlan-raw-device enp1s0f1np1
    vlan-id 400
    mtu 9000

auto eno.400
iface eno.400 inet manual
    vlan-raw-device eno1
    vlan-id 400
    mtu 9000

# Q-in-Q VLAN 400.100 - Unified BGP RR network
auto vlan100-p1
iface vlan100-p1 inet manual
    vlan-raw-device enp.400
    vlan-id 100
    mtu 1500

auto vlan100-p2
iface vlan100-p2 inet manual
    vlan-raw-device eno.400
    vlan-id 100
    mtu 1500

# Bond for BGP RR connectivity
auto bond-bgp
iface bond-bgp inet manual
    bond-slaves vlan100-p1 vlan100-p2
    bond-mode active-backup
    bond-primary vlan100-p1
    bond-miimon 100
    bond-lacp-rate fast
    bond-xmit-hash-policy layer3+4
    mtu 1500

# internal services bridge
auto vmbr1
iface vmbr1 inet static
    address 10.7.0.1
    netmask 255.255.0.0
    bridge-ports none
    bridge-stp off
    bridge-fd 0

iface vmbr1 inet6 static
    address 2401:a860:1007::1/48
    accept_ra 0
    autoconf 0

# public services bridge (BGP RR network)
auto vmbr2
iface vmbr2 inet static
    bridge-ports bond-bgp
    bridge-stp off
    bridge-fd 0
    address 10.155.100.7/24
    mtu 1500
    # policy-based routing for public services
    # ensures traffic from public IPs uses BIRD routes (main table)
    # anycast rules have higher priority to ensure proper routing
    post-up ip rule add from 160.22.180.180 lookup anycast priority 45
    post-up ip rule add from 160.22.181.81 lookup anycast priority 46
    post-up ip rule add from 10.155.181.81 lookup anycast priority 47
    post-up ip rule add from 160.22.181.7 lookup anycast priority 49
    post-up ip rule add from 160.22.181.7 lookup main priority 50
    post-up ip rule add from 10.155.181.81 lookup main priority 51
    post-up ip rule add from 160.22.181.81 lookup main priority 52
    post-up ip rule add from 160.22.180.180 lookup main priority 53
    post-up ip route add default table anycast nexthop via 10.155.100.1 dev vmbr2 weight 1 nexthop via 10.155.100.2 dev vmbr2 weight 1 2>/dev/null || true
    # VM public IP route
    post-up ip route add 160.22.181.252/32 dev vmbr2 2>/dev/null || true
    # critical: ensure return traffic uses the same interface
    post-up ip rule add iif vmbr2 lookup main priority 60
    # cleanup on interface down
    pre-down ip rule del from 160.22.181.7 lookup anycast 2>/dev/null || true
    pre-down ip rule del from 160.22.181.7 lookup main 2>/dev/null || true
    pre-down ip rule del from 160.22.180.180 lookup anycast priority 45 2>/dev/null || true
    pre-down ip rule del from 160.22.180.180 lookup main 2>/dev/null || true
    pre-down ip rule del from 160.22.181.81 lookup anycast priority 46 2>/dev/null || true
    pre-down ip rule del from 160.22.181.81 lookup main 2>/dev/null || true
    pre-down ip rule del from 10.155.181.81 lookup anycast priority 47 2>/dev/null || true
    pre-down ip rule del from 10.155.181.81 lookup main 2>/dev/null || true
    pre-down ip route flush table anycast 2>/dev/null || true
    pre-down ip rule del iif vmbr2 lookup main 2>/dev/null || true
    pre-down ip route del 160.22.181.252/32 dev vmbr2 2>/dev/null || true

iface vmbr2 inet6 static
    address fd00:155:100::7/64
    accept_ra 0
    autoconf 0
    # policy-based routing for IPv6 public services
    # anycast rules have higher priority to ensure proper routing
    post-up ip -6 rule add from 2401:a860:: lookup anycast priority 45
    post-up ip -6 rule add from 2401:a860:1081:: lookup anycast priority 46
    post-up ip -6 rule add from fd00:a860:1081:: lookup anycast priority 47
    post-up ip -6 rule add from 2401:a860:1007:: lookup anycast priority 49
    post-up ip -6 rule add from 2401:a860:1007:: lookup main priority 50
    post-up ip -6 rule add from fd00:a860:1081:: lookup main priority 51
    post-up ip -6 rule add from 2401:a860:1081:: lookup main priority 52
    post-up ip -6 rule add from 2401:a860:: lookup main priority 53
    post-up ip -6 route add default table anycast nexthop via fd00:155:100::1 dev vmbr2 weight 1 nexthop via fd00:155:100::2 dev vmbr2 weight 1 2>/dev/null || true
    # VM public IPv6 route
    post-up ip -6 route add 2401:a860:1252::/128 dev vmbr2 2>/dev/null || true
    # critical: ensure return traffic uses the same interface
    post-up ip -6 rule add iif vmbr2 lookup main priority 60
    # cleanup on interface down
    pre-down ip -6 rule del from 2401:a860:1007:: lookup anycast 2>/dev/null || true
    pre-down ip -6 rule del from 2401:a860:1007:: lookup main 2>/dev/null || true
    pre-down ip -6 rule del from 2401:a860:: lookup anycast priority 45 2>/dev/null || true
    pre-down ip -6 rule del from 2401:a860:: lookup main 2>/dev/null || true
    pre-down ip -6 rule del from 2401:a860:1081:: lookup anycast priority 46 2>/dev/null || true
    pre-down ip -6 rule del from 2401:a860:1081:: lookup main 2>/dev/null || true
    pre-down ip -6 rule del from fd00:a860:1081:: lookup anycast priority 47 2>/dev/null || true
    pre-down ip -6 rule del from fd00:a860:1081:: lookup main 2>/dev/null || true
    pre-down ip -6 route flush table anycast 2>/dev/null || true
    pre-down ip -6 rule del iif vmbr2 lookup main 2>/dev/null || true
    pre-down ip -6 route del 2401:a860:1252::/128 dev vmbr2 2>/dev/null || true
