# network interface settings; autogenerated
# Please do NOT modify this file directly, unless you know what
# you're doing.
#
# If you want to manage parts of the network configuration manually,
# please utilize the 'source' or 'source-directory' directives to do
# so.
# PVE will preserve these directives, but will NOT read its network
# configuration from sourced files, so do not attempt to move any of
# the PVE managed interfaces into external files!

source /etc/network/interfaces.d/*

auto lo
iface lo inet loopback
# IPv6 primary loopback
    #up ip -6 addr add 2401:a860:181::7/128 dev lo
    #RouterId
    up ip -6 addr add fd00:155:255::7/128 dev lo
    # IPv4 legacy loopback
    #up ip addr add 160.22.181.7/32 dev lo
    #RouterId
    up ip addr add 10.155.255.7/32 dev lo

#bkk10
iface eno1 inet manual

#bkk50
iface eno2 inet manual

#bkk50
auto vmbr0
iface vmbr0 inet static
	address 192.168.77.1
	netmask 255.255.0.0
	gateway 192.168.69.1
	dns-nameservers 9.9.9.9 1.0.0.1
	bridge-ports eno2
	bridge-stp off
	bridge-fd 0

#iface vmbr0 inet static
#	addess  vrrp_ipv6

#auto vmbrbkk10
#iface vmbrbkk10 inet static
	#address 160.22.181.7
	#netmask 255.2555.255.255

iface enp193s0f0 inet manual

iface enp193s0f1 inet manual

#BKK40
#auto enp1s0f0np0
#iface enp1s0f0np0 inet manual
	#ovs_type OVSPort
	#ovs_bridge vlanbr0
	#ovs_mtu 9000
	#ovs_options vlan_mode=trunk trunks=100,200 other_config:rstp-enable=true other_config:rstp-path-cost=128 other_config:rstp-port-admin-edge=false other_config:rstp-port-auto-edge=false other_config:rstp-port-mcheck=true

##BKK30
auto enp1s0f1np1
iface enp1s0f1np1 inet manual
	ovs_type OVSPort
	ovs_bridge vlanbr0
	ovs_mtu 9000
	ovs_options vlan_mode=trunk trunks=100,200 other_config:rstp-enable=true other_config:rstp-path-cost=128 other_config:rstp-port-admin-edge=false other_config:rstp-port-auto-edge=false other_config:rstp-port-mcheck=true

auto vlanraw400
iface vlanraw400 inet manual
    vlan-raw-device enp1s0f1np1
    vlan-id 400
    mtu 9000

auto vlan107
iface vlan107 inet manual
    vlan-raw-device vlanraw400
    vlan-id 107
    mtu 1500

auto vlan207
iface vlan207 inet manual
    vlan-raw-device vlanraw400
    vlan-id 207
    mtu 1500

# Internal services bridge (IPv6 primary)
auto vmbr1
iface vmbr1 inet6 static
    #address 2401:a860:7::1/64
    bridge-ports none
    bridge-stp off
    bridge-fd 0
    accept_ra 0
    autoconf 0
    # IPv6 routing for internal subnets
    #post-up ip -6 route add 2401:a860:7::/48 dev vmbr1

iface vmbr1 inet static
    address 10.7.0.1/24

# Public services bridge (Q-in-Q terminated)
auto vmbr2
iface vmbr2 inet static
    bridge-ports vlan207 vlan107
    bridge-stp off
    bridge-fd 0
    address 10.155.107.1/31
    address 10.155.207.1/31
    mtu 1500

iface vmbr2 inet6 static
    address fd00:155:107::1/127
    address fd00:155:207::1/127
    # Public IPs assigned to lo, not bridge
    # BGP will handle routing

auto vlanbr0
iface vlanbr0 inet static
    address 10.255.255.7/24
    ovs_type OVSBridge
    ovs_ports enp1s0f1np1 vpublic vprivate
    ovs_mtu 9000
    #pre-up ip link set dev enp1s0f0np0 mtu 9000
    pre-up ip link set dev enp1s0f1np1 mtu 9000
    up ovs-vsctl set Bridge ${IFACE} rstp_enable=true other_config:rstp-priority=32768 other_config:rstp-forward-delay=4 other_config:rstp-max-age=6
    #post-up ovs-vsctl set Port enp1s0f0np0 vlan_mode=trunk trunks=100,200
    post-up ovs-vsctl set Port enp1s0f1np1 vlan_mode=trunk trunks=100,200
    # VLAN 200 flows
    #post-up ovs-ofctl add-flow ${IFACE} "priority=250,in_port=enp1s0f0np0,dl_vlan=200,actions=strip_vlan,output:vprivate"
    post-up ovs-ofctl add-flow ${IFACE} "priority=250,in_port=enp1s0f1np1,dl_vlan=200,actions=strip_vlan,output:vprivate"
    post-up ovs-ofctl add-flow ${IFACE} "priority=250,in_port=vprivate,actions=push_vlan:0x8100,mod_vlan_vid:200,output:enp1s0f1np1"
    # VLAN 100 flows
    #post-up ovs-ofctl add-flow ${IFACE} "priority=250,in_port=enp1s0f0np0,dl_vlan=100,actions=strip_vlan,output:vpublic"
    post-up ovs-ofctl add-flow ${IFACE} "priority=250,in_port=enp1s0f1np1,dl_vlan=100,actions=strip_vlan,output:vpublic"
    post-up ovs-ofctl add-flow ${IFACE} "priority=250,in_port=vpublic,actions=push_vlan:0x8100,mod_vlan_vid:100,output:enp1s0f1np1"
    post-up sleep 10
    post-up ip link set dev ${IFACE} mtu 9000

iface vlanbr0 inet6 static
    address fd00:255:255::7/64

auto vpublic
iface vpublic inet static
  ovs_type OVSIntPort
  ovs_bridge vlanbr0
  ovs_options tag=100
  address 10.255.100.7/24
  ovs_mtu 9000

iface vpublic inet6 static
  address fd00:255:100::7/64

auto vprivate
iface vprivate inet static
  ovs_type OVSIntPort
  ovs_bridge vlanbr0
  ovs_options tag=200
  address 10.255.200.7/24
  ovs_mtu 9000

iface vprivate inet6 static
  address fd00:255:200::7/64

#iface enp1s0f0np0 inet manual

#iface enp1s0f1np1 inet manual

iface enxbe3af2b6059f inet manual

