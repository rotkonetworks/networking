table inet filter {
	set allowed_ssh {
		type ipv4_addr
		flags interval
		elements = { 0.0.0.0/0 }
	}

	set allowed_ssh_v6 {
		type ipv6_addr
		flags interval
		elements = { 2401:a860::/32,
			     fd00::/8 }
	}

	chain input {
		type filter hook input priority filter; policy drop;
		ct state established,related accept
		ct state invalid drop
		iif "lo" accept
		ip6 nexthdr ipv6-icmp icmpv6 type { destination-unreachable, packet-too-big, time-exceeded, parameter-problem, echo-request, echo-reply, nd-router-solicit, nd-router-advert, nd-neighbor-solicit, nd-neighbor-advert } accept
		ip protocol icmp icmp type { destination-unreachable, echo-request, time-exceeded, parameter-problem } limit rate 10000/second accept
		tcp dport 179 ip saddr { 10.155.107.0, 10.155.207.0 } accept
		tcp dport 179 ip6 saddr { fd00:155:107::, fd00:155:207:: } accept
		udp dport { 3784, 4784 } ip saddr { 10.155.107.0, 10.155.207.0 } accept
		udp dport { 3784, 4784 } ip6 saddr { fd00:155:107::, fd00:155:207:: } accept
		ip protocol ospf accept
		ip6 nexthdr ospf accept
		tcp dport 22 ip saddr 0.0.0.0/0 accept
		tcp dport 22 ip6 saddr { 2401:a860::/32, fd00::/8 } accept
		iifname "vmbr0" tcp dport { 111, 2049, 3128, 8006 } accept
		iifname "vmbr0" udp dport { 111, 5405-5412 } accept
		iifname "vmbr1" udp dport 53 accept
		iifname "vmbr1" tcp dport 53 accept
		iifname "vmbr0" udp dport 53 accept
		iifname "vmbr0" tcp dport 53 accept
		ip daddr 10.155.181.81 tcp dport { 53, 853 } accept
		ip daddr 10.155.181.81 udp dport 53 accept
		ip6 daddr fd00:a860:1081:: tcp dport { 53, 853 } accept
		ip6 daddr fd00:a860:1081:: udp dport 53 accept
		ip daddr 160.22.181.81 tcp dport { 80, 443 } accept
		ip daddr 160.22.181.81 tcp dport { 53, 853 } accept
		ip daddr 160.22.181.81 udp dport 53 accept
		ip6 daddr 2401:a860:1081:: tcp dport { 80, 443 } accept
		ip6 daddr 2401:a860:1081:: tcp dport { 53, 853 } accept
		ip6 daddr 2401:a860:1081:: udp dport 53 accept
		ip daddr 160.22.180.180 tcp dport { 80, 443 } accept
		ip daddr 160.22.180.180 tcp dport { 53, 853 } accept
		ip daddr 160.22.180.180 udp dport 53 accept
		ip6 daddr 2401:a860:: tcp dport { 80, 443 } accept
		ip6 daddr 2401:a860:: tcp dport { 53, 853 } accept
		ip6 daddr 2401:a860:: udp dport 53 accept
		tcp dport { 80, 443 } accept
		iif "lo" tcp dport 8404 accept
		tcp dport { 8233, 30335, 31012, 31022, 31032, 31052, 32012, 32022, 32042, 32052, 32062, 33312, 33322, 33342, 33847, 33957, 33967, 34031, 34042, 34052, 34071 } accept
		udp dport { 8233, 30335, 31012, 31022, 31032, 31052, 32012, 32022, 32042, 32052, 32062, 33312, 33322, 33342, 33847, 33957, 33967, 34031, 34042, 34052, 34071 } accept
		tcp dport 30435 accept
		limit rate 5/minute log prefix "[DROP-IN] "
	}

	chain forward {
		type filter hook forward priority filter; policy drop;
		ct state established,related accept
		ct state invalid drop
		iifname "vmbr1" accept
		iifname "vmbr0" accept
		ct status dnat accept
		ip saddr 192.168.0.0/16 accept
		limit rate 5/minute log prefix "[DROP-FWD] "
	}

	chain output {
		type filter hook output priority filter; policy accept;
	}
}
table ip nat {
	chain prerouting {
		type nat hook prerouting priority dstnat; policy accept;
		tcp dport 25001 dnat to 10.7.0.100:22
		tcp dport 33312 dnat to 10.7.112.10:33312
		udp dport 33312 dnat to 10.7.112.10:33312
		tcp dport 33342 dnat to 10.7.142.10:33342
		udp dport 33342 dnat to 10.7.142.10:33342
		tcp dport 33322 dnat to 10.7.122.10:33322
		udp dport 33322 dnat to 10.7.122.10:33322
		tcp dport 31012 dnat to 10.7.112.11:31012
		udp dport 31012 dnat to 10.7.112.11:31012
		tcp dport 32012 dnat to 10.7.122.11:32012
		udp dport 32012 dnat to 10.7.122.11:32012
		tcp dport 33957 dnat to 10.7.142.11:33957
		udp dport 33957 dnat to 10.7.142.11:33957
		tcp dport 34071 dnat to 10.7.141.17:34071
		udp dport 34071 dnat to 10.7.141.17:34071
		tcp dport 31022 dnat to 10.7.112.12:31022
		udp dport 31022 dnat to 10.7.112.12:31022
		tcp dport 32022 dnat to 10.7.122.12:32022
		udp dport 32022 dnat to 10.7.122.12:32022
		tcp dport 33967 dnat to 10.7.142.12:33967
		udp dport 33967 dnat to 10.7.142.12:33967
		tcp dport 31032 dnat to 10.7.112.13:31032
		udp dport 31032 dnat to 10.7.112.13:31032
		tcp dport 34031 dnat to 10.7.141.13:34031
		udp dport 34031 dnat to 10.7.141.13:34031
		tcp dport 33847 dnat to 10.7.112.14:33847
		udp dport 33847 dnat to 10.7.112.14:33847
		tcp dport 32042 dnat to 10.7.122.14:32042
		udp dport 32042 dnat to 10.7.122.14:32042
		tcp dport 34042 dnat to 10.7.142.14:34042
		udp dport 34042 dnat to 10.7.142.14:34042
		tcp dport 31052 dnat to 10.7.112.15:31052
		udp dport 31052 dnat to 10.7.112.15:31052
		tcp dport 32052 dnat to 10.7.122.15:32052
		udp dport 32052 dnat to 10.7.122.15:32052
		tcp dport 34052 dnat to 10.7.142.15:34052
		udp dport 34052 dnat to 10.7.142.15:34052
		tcp dport 32062 dnat to 10.7.122.16:32062
		udp dport 32062 dnat to 10.7.122.16:32062
		tcp dport 8233 dnat to 10.7.0.201:8233
		udp dport 8233 dnat to 10.7.0.201:8233
	}

	chain postrouting {
		type nat hook postrouting priority srcnat; policy accept;
		ip saddr 10.7.0.0/16 oifname "vmbr2" snat to 160.22.181.7
		ip saddr 192.168.0.0/16 oifname "vmbr2" snat to 160.22.181.7
	}
}
table ip6 nat {
}
