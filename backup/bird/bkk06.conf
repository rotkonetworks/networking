  # BIRD 2.x configuration for BKK06
  # Generated: 2025-11-10T11:26:01Z
  # Config hash: 9b14f81c95605cb6a754f1f559f71a3da962f21a68e8bcea216c43048a3db5fb

    #
  # Router Identity and Constants
  #
  router id 10.155.255.6;

# AS Numbers
define LOCAL_AS = 142108;

# Public IPs
define PUBLIC_IP4 = 160.22.181.6;
define PUBLIC_IP6 = 2401:a860:1006::;

# Network Prefixes
define PUBLIC_NET4 = 160.22.181.6/32;
define PUBLIC_NET6 = 2401:a860:1006::/128;
define INTERNAL_NET4 = 10.6.0.0/16;
define INTERNAL_NET6 = 2401:a860:1006::/48;

# Anycast IPv4 addresses (/32)
define ANYCAST_LOCAL_V4 = 10.155.181.81/32;  # ULA - internal only
define ANYCAST_SITE_V4 = 160.22.181.81/32;    # Bangkok site-local
define ANYCAST_GLOBAL_V4 = 160.22.180.180/32; # Global multi-site

# Anycast IPv6 host addresses (/128 - for loopback)
define ANYCAST_LOCAL_V6_HOST = fd00:a860:1081::/128;  # ULA - internal
define ANYCAST_SITE_V6_HOST = 2401:a860:1081::/128;    # GUA - Bangkok
define ANYCAST_GLOBAL_V6_HOST = 2401:a860::/128; # GUA - global

# Anycast IPv6 network prefixes (for BGP announcement)
define ANYCAST_LOCAL_V6_PREFIX = fd00:a860:1081::/48;  # ULA /48 - internal only
define ANYCAST_SITE_V6_PREFIX = 2401:a860:1081::/48;    # GUA /48 - Bangkok
define ANYCAST_GLOBAL_V6_PREFIX = 2401:a860::/36; # GUA /36 - global

# Route Reflector IPs
define RR1_IP4 = 10.155.106.0;
define RR2_IP4 = 10.155.206.0;
define RR1_IP6 = fd00:155:106::;
define RR2_IP6 = fd00:155:206::;

# Local IPs for BGP sessions
define LOCAL_IP4_RR1 = 10.155.106.1;
define LOCAL_IP6_RR1 = fd00:155:106::1;
define LOCAL_IP4_RR2 = 10.155.206.1;
define LOCAL_IP6_RR2 = fd00:155:206::1;

# BGP Preferences
define PREF_IPV6 = 200;
define PREF_IPV4 = 150;
define LOCAL_PREF_PRIMARY = 100;
define LOCAL_PREF_BACKUP = 90;

# Timers
define BGP_HOLD_TIME = 30;
define BGP_KEEPALIVE = 10;
define BFD_MIN_RX = 100;
define BFD_MIN_TX = 100;
define BFD_MULTIPLIER = 3;
define SCAN_TIME = 10;

    #
  # Logging Configuration
  #
  log syslog all;
  log "/var/log/bird.log" all;

  timeformat base iso long;
  timeformat log iso long;
  timeformat protocol iso long;
  timeformat route iso long;

    #
  # BGP Templates
  #
  template bgp BGP_COMMON {
  local as LOCAL_AS;
  # Direct connection over vmbr2
  direct;

    # Faster convergence
    hold time BGP_HOLD_TIME;
    keepalive time BGP_KEEPALIVE;

    # BFD for fast failure detection
    bfd on;

    # Graceful restart
    graceful restart on;
    graceful restart time 120;
  }

    #
  # Kernel Protocols
  #
  protocol kernel kernel4 {
  ipv4 {
  export filter {
  # Don't export kernel routes back
  if source = RTS_DEVICE then reject;
    if source = RTS_STATIC then reject;
      accept;
    };
    import all;
  };
  learn;
  scan time SCAN_TIME;
  merge paths on;
}

protocol kernel kernel6 {
ipv6 {
export filter {
if source = RTS_DEVICE then reject;
  if source = RTS_STATIC then reject;
    accept;
  };
  import all;
};
learn;
scan time SCAN_TIME;
merge paths on;
}

    #
  # Basic Protocols
  #
  protocol device {
  scan time SCAN_TIME;
}

protocol direct {
ipv4;
ipv6;
interface "vmbr*", "lo", "vmbr2";
}

    #
  # Static Routes
  #
  protocol static static4 {
  ipv4;
  route PUBLIC_NET4 unreachable;
    route 10.155.181.81/32 unreachable;  # ULA - internal only
    route 160.22.181.81/32 unreachable;    # Bangkok site-local
    route 160.22.180.180/32 unreachable;  # Global multi-site
  route INTERNAL_NET4 unreachable;
}

protocol static static6 {
ipv6;
route PUBLIC_NET6 unreachable;
    # Local anycast (ULA) - internal use only
    route fd00:a860:1081::/128 unreachable;
    route fd00:a860:1081::/48 unreachable;
    # Site anycast (GUA) - Bangkok only
    route 2401:a860:1081::/128 unreachable;
    route 2401:a860:1081::/48 unreachable;
    # Global anycast (GUA) - multi-site
    route 2401:a860::/128 unreachable;
    route 2401:a860::/36 unreachable;
  route INTERNAL_NET6 unreachable;
}

    #
  # BFD Protocol
  #
  protocol bfd {
  interface "vmbr2" {
  min rx interval BFD_MIN_RX ms;
  min tx interval BFD_MIN_TX ms;
  multiplier BFD_MULTIPLIER;
};
}

  #
# BGP Sessions to Route Reflectors
#

    protocol bgp RR1_v6 from BGP_COMMON {
    description "Route Reflector - bkk00 IPv6";
    neighbor RR1_IP6 as LOCAL_AS;
    source address LOCAL_IP6_RR1;

    ipv6 {
    next hop self;
    import filter {
    # Prefer IPv6 routes
    preference = PREF_IPV6;

            # Accept default route
            if net = ::/0 then {
              bgp_local_pref = LOCAL_PREF_PRIMARY;
              accept;
            }

            # Accept all other routes
            accept;
          };
          export filter {
          # Export our unicast
          if net = PUBLIC_NET6 then accept;

            # Export anycast /128 host addresses
            if net = ANYCAST_SITE_V6_HOST then accept;
            if net = ANYCAST_GLOBAL_V6_HOST then accept;

            # Export GUA anycast prefixes for external BGP
            # Site-local /48 - Bangkok only services
            if net = ANYCAST_SITE_V6_PREFIX then accept;
              # Global /36 - worldwide services
              if net = ANYCAST_GLOBAL_V6_PREFIX then accept;

            # ULA anycast stays internal only (not exported to eBGP)
            # But we can export to iBGP for internal routing
            if net = ANYCAST_LOCAL_V6_PREFIX then accept;

            # Internal networks
            if net ~ INTERNAL_NET6 then accept;

            # Don't export learned routes
            reject;
          };
        };
      }

    protocol bgp RR1_v4 from BGP_COMMON {
    description "Route Reflector - bkk00 IPv4";
    neighbor RR1_IP4 as LOCAL_AS;
    source address LOCAL_IP4_RR1;

    ipv4 {
    next hop self;
    import filter {
    # Lower preference for IPv4
    preference = PREF_IPV4;

            # Accept default
            if net = 0.0.0.0/0 then {
              bgp_local_pref = LOCAL_PREF_BACKUP;
              accept;
            }
            accept;
          };
          export filter {
          if net = PUBLIC_NET4 then accept;

            # Export all anycast /32 addresses
            if net = ANYCAST_LOCAL_V4 then accept;  # ULA - internal
              if net = ANYCAST_SITE_V4 then accept;   # Bangkok only
                if net = ANYCAST_GLOBAL_V4 then accept; # Global

                  if net ~ INTERNAL_NET4 then accept;
                    reject;
                  };
                };
              }

    protocol bgp RR2_v6 from BGP_COMMON {
    description "Route Reflector - bkk20 IPv6";
    neighbor RR2_IP6 as LOCAL_AS;
    source address LOCAL_IP6_RR2;

    ipv6 {
    next hop self;
    import filter {
    # Prefer IPv6 routes
    preference = PREF_IPV6;

            # Accept default route
            if net = ::/0 then {
              bgp_local_pref = LOCAL_PREF_PRIMARY;
              accept;
            }

            # Accept all other routes
            accept;
          };
          export filter {
          # Export our unicast
          if net = PUBLIC_NET6 then accept;

            # Export anycast /128 host addresses
            if net = ANYCAST_SITE_V6_HOST then accept;
            if net = ANYCAST_GLOBAL_V6_HOST then accept;

            # Export GUA anycast prefixes for external BGP
            # Site-local /48 - Bangkok only services
            if net = ANYCAST_SITE_V6_PREFIX then accept;
              # Global /36 - worldwide services
              if net = ANYCAST_GLOBAL_V6_PREFIX then accept;

            # ULA anycast stays internal only (not exported to eBGP)
            # But we can export to iBGP for internal routing
            if net = ANYCAST_LOCAL_V6_PREFIX then accept;

            # Internal networks
            if net ~ INTERNAL_NET6 then accept;

            # Don't export learned routes
            reject;
          };
        };
      }

    protocol bgp RR2_v4 from BGP_COMMON {
    description "Route Reflector - bkk20 IPv4";
    neighbor RR2_IP4 as LOCAL_AS;
    source address LOCAL_IP4_RR2;

    ipv4 {
    next hop self;
    import filter {
    # Lower preference for IPv4
    preference = PREF_IPV4;

            # Accept default
            if net = 0.0.0.0/0 then {
              bgp_local_pref = LOCAL_PREF_BACKUP;
              accept;
            }
            accept;
          };
          export filter {
          if net = PUBLIC_NET4 then accept;

            # Export all anycast /32 addresses
            if net = ANYCAST_LOCAL_V4 then accept;  # ULA - internal
              if net = ANYCAST_SITE_V4 then accept;   # Bangkok only
                if net = ANYCAST_GLOBAL_V4 then accept; # Global

                  if net ~ INTERNAL_NET4 then accept;
                    reject;
                  };
                };
              }


# UNIFIED RR NETWORK - 10.155.100.x (ECMP)
define UNIFIED_RR1_IP4 = 10.155.100.1;
define UNIFIED_RR2_IP4 = 10.155.100.2;
define UNIFIED_RR1_IP6 = fd00:155:100::1;
define UNIFIED_RR2_IP6 = fd00:155:100::2;
define UNIFIED_LOCAL_IP4 = 10.155.100.6;
define UNIFIED_LOCAL_IP6 = fd00:155:100::6;

protocol bgp RR1_UNIFIED_v4 from BGP_COMMON {
    description "Route Reflector 1 - bkk00 IPv4 UNIFIED";
    neighbor UNIFIED_RR1_IP4 as LOCAL_AS;
    source address UNIFIED_LOCAL_IP4;
    ipv4 {
        next hop self;
        import filter { accept; };
        export filter {
            if net = PUBLIC_NET4 then accept;
            if net = ANYCAST_LOCAL_V4 then accept;
            if net = ANYCAST_SITE_V4 then accept;
            if net = ANYCAST_GLOBAL_V4 then accept;
            if net ~ INTERNAL_NET4 then accept;
            reject;
        };
    };
}

protocol bgp RR1_UNIFIED_v6 from BGP_COMMON {
    description "Route Reflector 1 - bkk00 IPv6 UNIFIED";
    neighbor UNIFIED_RR1_IP6 as LOCAL_AS;
    source address UNIFIED_LOCAL_IP6;
    ipv6 {
        next hop self;
        import filter { accept; };
        export filter {
            if net = PUBLIC_NET6 then accept;
            if net = ANYCAST_LOCAL_V6_HOST then accept;
            if net = ANYCAST_SITE_V6_HOST then accept;
            if net = ANYCAST_GLOBAL_V6_HOST then accept;
            if net ~ ANYCAST_SITE_V6_PREFIX then accept;
            if net ~ ANYCAST_GLOBAL_V6_PREFIX then accept;
            reject;
        };
    };
}

protocol bgp RR2_UNIFIED_v4 from BGP_COMMON {
    description "Route Reflector 2 - bkk20 IPv4 UNIFIED";
    neighbor UNIFIED_RR2_IP4 as LOCAL_AS;
    source address UNIFIED_LOCAL_IP4;
    ipv4 {
        next hop self;
        import filter { accept; };
        export filter {
            if net = PUBLIC_NET4 then accept;
            if net = ANYCAST_LOCAL_V4 then accept;
            if net = ANYCAST_SITE_V4 then accept;
            if net = ANYCAST_GLOBAL_V4 then accept;
            if net ~ INTERNAL_NET4 then accept;
            reject;
        };
    };
}

protocol bgp RR2_UNIFIED_v6 from BGP_COMMON {
    description "Route Reflector 2 - bkk20 IPv6 UNIFIED";
    neighbor UNIFIED_RR2_IP6 as LOCAL_AS;
    source address UNIFIED_LOCAL_IP6;
    ipv6 {
        next hop self;
        import filter { accept; };
        export filter {
            if net = PUBLIC_NET6 then accept;
            if net = ANYCAST_LOCAL_V6_HOST then accept;
            if net = ANYCAST_SITE_V6_HOST then accept;
            if net = ANYCAST_GLOBAL_V6_HOST then accept;
            if net ~ ANYCAST_SITE_V6_PREFIX then accept;
            if net ~ ANYCAST_GLOBAL_V6_PREFIX then accept;
            reject;
        };
    };
}
